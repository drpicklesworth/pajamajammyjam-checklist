<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Pajama Jammy Jam - Party Checklist</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            min-height: 100dvh;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            padding-top: 100px;
            padding-bottom: 40px;
            position: relative;
        }

        /* Password overlay - COMMENTED OUT - uncomment entire section to enable */
        /*
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .password-overlay.hidden {
            display: none;
        }

        .password-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #d4af37;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .password-box h2 {
            color: #d4af37;
            margin-bottom: 15px;
            text-align: center;
            font-size: 20px;
        }

        .password-box input {
            width: 220px;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #d4af37;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Courier New', monospace;
        }

        .password-box button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            font-size: 14px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .password-error {
            color: #ff6b6b;
            margin-top: 8px;
            text-align: center;
            font-size: 12px;
            min-height: 16px;
        }
        */

        /* Name Entry Overlay */
        .name-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .name-overlay.hidden {
            display: none;
        }

        .name-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #d4af37;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .name-box h2 {
            color: #d4af37;
            margin-bottom: 15px;
            text-align: center;
            font-size: 20px;
        }

        .name-box input {
            width: 220px;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #d4af37;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Courier New', monospace;
        }

        .name-box button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            font-size: 14px;
            background: #d4af37;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .name-error {
            color: #ff6b6b;
            margin-top: 8px;
            text-align: center;
            font-size: 12px;
            min-height: 16px;
        }

        .main-title {
            position: absolute;
            top: 15px;
            font-size: 32px;
            color: #d4af37;
            font-weight: normal;
            font-family: 'Great Vibes', cursive;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
            text-align: center;
        }

        .instruction {
            position: absolute;
            top: 60px;
            color: #d4af37;
            font-size: 14px;
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            text-align: center;
            transition: opacity 0.3s ease;
        }

        .instruction.hidden {
            opacity: 0;
        }

        .subtitle {
            position: absolute;
            top: 55px;
            font-size: 16px;
            color: #d4af37;
            opacity: 0;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-align: center;
            transition: opacity 0.5s ease 0.8s;
        }

        .subtitle.show {
            opacity: 0.8;
        }

        .envelope-container {
            perspective: 1000px;
            cursor: pointer;
            width: 350px;
            transition: all 0.6s ease;
        }

        .envelope-container.opened {
            cursor: default;
        }

        @media (max-width: 400px) {
            .envelope-container {
                width: 300px;
            }
        }

        .envelope {
            width: 350px;
            height: 280px;
            position: relative;
            transition: height 0.6s ease 0.8s;
            margin: 0 auto;
        }

        .envelope.open {
            height: auto;
            min-height: 500px;
        }

        @media (max-width: 400px) {
            .envelope {
                width: 300px;
                height: 240px;
            }
        }

        .envelope-back {
            width: 100%;
            height: 100%;
            min-height: 280px;
            background: #e8d7b8;
            border: 3px solid #c4a777;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: min-height 0.6s ease 0.8s;
        }

        .envelope.open .envelope-back {
            min-height: 500px;
        }

        .envelope-flap {
            width: 0;
            height: 0;
            border-left: 175px solid transparent;
            border-right: 175px solid transparent;
            border-top: 140px solid #d4c4a0;
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: top center;
            transition: transform 0.8s ease, opacity 0.3s ease 0.8s;
            z-index: 3;
        }

        .envelope.open .envelope-flap {
            transform: rotateX(-180deg);
            opacity: 0;
            pointer-events: none;
        }

        .wax-seal {
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #c41e3a 0%, #8b0000 100%);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 4;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.8s ease;
            color: #8b0000;
            font-size: 20px;
            font-weight: bold;
            font-family: 'Georgia', serif;
        }

        .envelope.open .wax-seal {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.5);
        }

        .checklist-content {
            width: 90%;
            height: 85%;
            background: #fffef7;
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.4s ease 0.4s, top 0.6s ease 0.4s, height 0.6s ease 0.8s;
            border: 1px solid #d4c4a0;
            z-index: 1;
            display: flex;
            flex-direction: column;
        }

        .envelope.open .checklist-content {
            opacity: 1;
            top: 50%;
            height: 90%;
        }

        .checklist-title {
            font-size: 18px;
            font-weight: bold;
            color: #2a2a2a;
            text-align: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #d4c4a0;
        }

        .task-list {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 3px 4px;
            background: rgba(212, 196, 160, 0.08);
            border-radius: 3px;
            transition: background 0.2s ease;
        }

        .task-item:active {
            background: rgba(212, 196, 160, 0.2);
        }

        .task-item.completed {
            opacity: 0.5;
        }

        .task-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .task-text {
            color: #2a2a2a;
            font-size: 12px;
            line-height: 1.3;
            flex-grow: 1;
            cursor: pointer;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #4a9b4a;
        }

        .navigation-arrows {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .nav-arrow {
            font-size: 24px;
            color: #8b7355;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s ease, transform 0.2s ease;
            padding: 0 5px;
        }

        .nav-arrow:hover {
            color: #6b5845;
            transform: scale(1.2);
        }

        .nav-arrow.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 10px;
            color: #8b7355;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Password Overlay - COMMENTED OUT -->
    <!--
    <div class="password-overlay" id="passwordOverlay">
        <div class="password-box">
            <h2>Enter Password</h2>
            <input type="password" id="passwordInput" placeholder="Password" />
            <button onclick="checkPassword()">Enter</button>
            <div class="password-error" id="passwordError"></div>
        </div>
    </div>
    -->

    <!-- Name Entry Overlay -->
    <div class="name-overlay" id="nameOverlay">
        <div class="name-box">
            <h2>Enter Your Name</h2>
            <input type="text" id="nameInput" placeholder="Your name" />
            <button onclick="submitName()">Continue</button>
            <div class="name-error" id="nameError"></div>
        </div>
    </div>

    <div class="main-title">Pajama Jammy Jam</div>
    <div class="subtitle" id="subtitle">Party Checklist</div>
    <div class="instruction" id="instruction">Tap the envelope to open</div>

    <div class="envelope-container" id="envelopeContainer">
        <div class="envelope" id="envelope" onclick="openEnvelope()">
            <div class="envelope-back">
                <div class="envelope-flap"></div>
                <div class="wax-seal">PJ</div>
                <div class="checklist-content">
                    <div class="checklist-title">Tasks</div>
                    <div class="task-list" id="taskList"></div>
                    <div class="navigation-arrows">
                        <span class="nav-arrow" id="prevArrow" onclick="prevPage(event)">‚Äπ</span>
                        <div>
                            <div class="page-info" id="pageInfo">Page 1</div>
                        </div>
                        <span class="nav-arrow" id="nextArrow" onclick="nextPage(event)">‚Ä∫</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // EDIT PASSWORD HERE (currently disabled)
        const correctPassword = "party";
        
        // EDIT GOOGLE APPS SCRIPT URL HERE
        const SYNC_URL = 'https://script.google.com/macros/s/AKfycbxuzg6fbzzHHVvGvITQ5iYLae_FQraJjLFjfqrTBKfGdoCYcnBq5-KYAG34cWNLj1ldgA/exec';
        
        let tasks = [];
        let currentPage = 0;
        let tasksPerPage = 6;
        let isOpen = false;
        let userName = '';
        let urlParam = '';
        let contestantName = '';

        // Function to calculate how many tasks fit per page
        function calculateTasksPerPage() {
            if (!isOpen) return 6; // Default before opening
            
            const container = document.getElementById('taskList');
            if (!container) return 6;
            
            const containerHeight = container.clientHeight;
            const taskItem = container.querySelector('.task-item');
            
            if (!taskItem) return 6;
            
            const taskHeight = taskItem.offsetHeight;
            const gap = 5; // CSS gap between items
            const availableTasks = Math.floor(containerHeight / (taskHeight + gap));
            
            return Math.max(1, availableTasks); // At least 1 task
        }

        // Get URL parameter
        function getUrlParameter() {
            const params = new URLSearchParams(window.location.search);
            const keys = Array.from(params.keys());
            return keys.length > 0 ? keys[0] : '';
        }

        // Fetch contestant name from codeName
        async function fetchContestantName(codeName) {
            try {
                const res = await fetch(SYNC_URL);
                const data = await res.json();
                const contestants = data.contestants || [];
                const match = contestants.find(c => c.codeName === codeName);
                return match ? match.name : '';
            } catch (error) {
                console.error('Error fetching contestant:', error);
                return '';
            }
        }

        // Get URL parameter on load
        urlParam = getUrlParameter();

        // If URL param exists, validate it and skip name entry
        if (urlParam) {
            fetchContestantName(urlParam).then(name => {
                if (name) {
                    // Valid codeName found - skip name entry
                    contestantName = name;
                    userName = 'Anonymous'; // Set a default username for tracking
                    document.getElementById('nameOverlay').classList.add('hidden');
                    const subtitleEl = document.getElementById('subtitle');
                    subtitleEl.textContent = `Party Checklist - ${contestantName}`;
                } else {
                    // Invalid codeName - show normal name entry
                    if (localStorage.getItem('pjj_party_name')) {
                        userName = localStorage.getItem('pjj_party_name');
                        document.getElementById('nameOverlay').classList.add('hidden');
                    }
                }
            });
        } else {
            // No URL param - check if name is already stored
            if (localStorage.getItem('pjj_party_name')) {
                userName = localStorage.getItem('pjj_party_name');
                document.getElementById('nameOverlay').classList.add('hidden');
            }
        }

        // Name submission
        function submitName() {
            const input = document.getElementById('nameInput');
            const error = document.getElementById('nameError');
            
            if (input.value.trim().length > 0) {
                userName = input.value.trim();
                localStorage.setItem('pjj_party_name', userName);
                document.getElementById('nameOverlay').classList.add('hidden');
                error.textContent = '';
                
                // If URL param exists, fetch and display contestant name
                if (urlParam) {
                    fetchContestantName(urlParam).then(name => {
                        if (name) {
                            contestantName = name;
                            const subtitleEl = document.getElementById('subtitle');
                            subtitleEl.textContent = `Party Checklist - ${contestantName}`;
                        }
                    });
                }
                
                syncProgress(); // Initial sync
            } else {
                error.textContent = 'Please enter a name';
            }
        }

        document.getElementById('nameInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitName();
            }
        });

        /* Password functions - COMMENTED OUT
        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
            
            if (input.value === correctPassword) {
                localStorage.setItem('pjj_party_authenticated', 'true');
                document.getElementById('passwordOverlay').classList.add('hidden');
                error.textContent = '';
            } else {
                error.textContent = 'Incorrect password';
                input.value = '';
            }
        }

        if (localStorage.getItem('pjj_party_authenticated') === 'true') {
            document.getElementById('passwordOverlay').classList.add('hidden');
        }

        document.getElementById('passwordInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
        */

        async function loadTasks() {
            try {
                const response = await fetch('party-tasks.json');
                tasks = await response.json();
            } catch (error) {
                console.error('Error loading tasks:', error);
                tasks = [
                    "Jump in a group photo with everyone",
                    "Sing happy birthday (to Jason, obviously)",
                    "Order your favorite pizza topping for the group",
                    "Name three things you're grateful for",
                    "Exchange phone numbers with someone new",
                    "Rate the party snacks from best to worst",
                    "Reveal your most embarrassing pajama story",
                    "Organize a quick game of charades",
                    "Request your favorite song to be played"
                ];
            }
            renderPage();
        }

        function openEnvelope() {
            if (!isOpen) {
                document.getElementById('envelope').classList.add('open');
                document.getElementById('envelopeContainer').classList.add('opened');
                document.getElementById('instruction').classList.add('hidden');
                document.getElementById('subtitle').classList.add('show');
                isOpen = true;
                
                // Wait for animation to complete, then recalculate tasks per page
                setTimeout(() => {
                    tasksPerPage = calculateTasksPerPage();
                    currentPage = 0;
                    renderPage();
                }, 1400); // Wait for all transitions to complete
            }
        }

        function renderPage() {
            const startIdx = currentPage * tasksPerPage;
            const endIdx = Math.min(startIdx + tasksPerPage, tasks.length);
            const pageTasks = tasks.slice(startIdx, endIdx);
            
            const container = document.getElementById('taskList');
            container.innerHTML = '';

            pageTasks.forEach((task, idx) => {
                const globalIdx = startIdx + idx;
                const isChecked = loadCheckboxState(globalIdx);
                
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item' + (isChecked ? ' completed' : '');
                taskItem.innerHTML = `
                    <input type="checkbox" 
                           class="task-checkbox" 
                           id="task-${globalIdx}" 
                           ${isChecked ? 'checked' : ''}
                           onchange="handleCheckboxChange(${globalIdx})">
                    <label class="task-text" for="task-${globalIdx}" onclick="toggleTask(${globalIdx})">${task}</label>
                `;
                
                container.appendChild(taskItem);
            });

            updateNavigation();
            updateProgress();
        }

        function updateNavigation() {
            const totalPages = Math.ceil(tasks.length / tasksPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage + 1}/${totalPages}`;
            
            const prevArrow = document.getElementById('prevArrow');
            const nextArrow = document.getElementById('nextArrow');
            
            if (currentPage === 0) {
                prevArrow.classList.add('disabled');
            } else {
                prevArrow.classList.remove('disabled');
            }
            
            if (currentPage >= totalPages - 1) {
                nextArrow.classList.add('disabled');
            } else {
                nextArrow.classList.remove('disabled');
            }
        }

        function updateProgress() {
            let completed = 0;
            tasks.forEach((_, index) => {
                if (loadCheckboxState(index)) completed++;
            });
            // Progress count removed - no longer displayed
        }

        function prevPage(event) {
            event.stopPropagation();
            if (currentPage > 0) {
                currentPage--;
                renderPage();
            }
        }

        function nextPage(event) {
            event.stopPropagation();
            const totalPages = Math.ceil(tasks.length / tasksPerPage);
            if (currentPage < totalPages - 1) {
                currentPage++;
                renderPage();
            }
        }

        function loadCheckboxState(index) {
            return localStorage.getItem(`pjj_party_task_${index}`) === 'true';
        }

        function saveCheckboxState(index, checked) {
            localStorage.setItem(`pjj_party_task_${index}`, checked);
        }

        function handleCheckboxChange(index) {
            const checkbox = document.getElementById(`task-${index}`);
            const taskItem = checkbox.closest('.task-item');
            
            saveCheckboxState(index, checkbox.checked);
            
            if (checkbox.checked) {
                taskItem.classList.add('completed');
            } else {
                taskItem.classList.remove('completed');
            }
            
            updateProgress();
            syncProgress(); // Sync to backend
        }

        function toggleTask(index) {
            event.stopPropagation();
            const checkbox = document.getElementById(`task-${index}`);
            checkbox.checked = !checkbox.checked;
            handleCheckboxChange(index);
        }

        // Sync progress to Google Sheets
        async function syncProgress() {
            if (!userName) {
                console.log('‚ö†Ô∏è No username - skipping sync');
                return;
            }
            
            let completed = 0;
            tasks.forEach((_, index) => {
                if (loadCheckboxState(index)) completed++;
            });

            const payload = {
                name: userName,
                completed: completed,
                urlParam: urlParam
            };

            console.log('üì§ Syncing to server:', payload);
            console.log('üìç URL:', SYNC_URL);

            try {
                const response = await fetch(SYNC_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(payload)
                });
                console.log('‚úÖ Sync complete');
            } catch (error) {
                console.error('‚ùå Sync error:', error);
            }
        }

        loadTasks();
        
        // Auto-sync every 2 minutes
        setInterval(syncProgress, 120000);
    </script>
</body>
</html>
